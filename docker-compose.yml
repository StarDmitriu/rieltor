services:
  redis:
    image: redis:7-alpine
    container_name: chatrassylka_redis
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    restart: unless-stopped
    cpus: "0.50"
    mem_limit: 512m
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10

  backend:
    build:
      context: ./backend
    container_name: chatrassylka_backend
    env_file:
      - ./backend/.env
    environment:
      NODE_ENV: production
      PORT: 3000

      REDIS_HOST: redis
      REDIS_PORT: 6379
      # лучше оставить хост/порт, без url — так меньше сюрпризов
      # REDIS_URL: redis://redis:6379

      #TG_API_ID: "38841476"
      #TG_API_HASH: "f7d028dd897d7c54ed245b7a959bb68c"
      TELEGRAM_AUTOCONNECT: "false"

      #PRODAMUS_FORM_URL: ${PRODAMUS_FORM_URL}
      #PRODAMUS_SECRET_KEY: ${PRODAMUS_SECRET_KEY}
      #PRODAMUS_SYS: ${PRODAMUS_SYS}

      CAMPAIGN_REPEAT_ENABLED: "true"
      DEFAULT_TZ: Europe/Moscow

      #SMSRU_API_ID: ${SMSRU_API_ID}

      #SUPABASE_URL: ${SUPABASE_URL}
      #SUPABASE_KEY: ${SUPABASE_KEY}
      #JWT_SECRET: ${JWT_SECRET}
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/ >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 20
      start_period: 20s


    depends_on:
      redis:
        condition: service_healthy

    restart: unless-stopped
    stop_grace_period: 15s
    cpus: "1.00"
    mem_limit: 1536m
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    #healthcheck:
      # если у тебя нет /health — можно заменить на проверку порта
      #test: ["CMD-SHELL", "wget -qO- http://localhost:3000/health >/dev/null 2>&1 || exit 1"]
      #interval: 15s
      #timeout: 5s
      #retries: 10

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_BACKEND_URL: /api
    container_name: chatrassylka_frontend
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_BACKEND_URL: /api
      # Внутренний URL бэкенда для SSR/rewrites — избегаем запросов на публичный IP из контейнера
      BACKEND_INTERNAL_URL: http://backend:3000
      HOSTNAME: "0.0.0.0"   # слушать на всех интерфейсах — иначе healthcheck (localhost) не проходит
      NODE_OPTIONS: --enable-source-maps
      TURBOPACK: "0"

    depends_on:
      backend:
        condition: service_healthy

    restart: unless-stopped
    stop_grace_period: 15s

    cpus: "1.00"
    mem_limit: 768m   # <-- поставь сюда лимит (или 1024m)

    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3001/ >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 20
      start_period: 30s

  nginx:
    image: nginx:alpine
    container_name: chatrassylka_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./deploy/certbot/www:/var/www/certbot:ro
      - ./deploy/certbot/conf:/etc/letsencrypt:ro

    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy

    restart: unless-stopped
    stop_grace_period: 10s
    cpus: "0.50"
    mem_limit: 512m
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    #healthcheck:
      #test: ["CMD-SHELL", "wget -qO- http://localhost >/dev/null 2>&1 || exit 1"]
      #interval: 15s
      #timeout: 5s
      #retries: 10

volumes:
  redis_data:
